name: Test mitmproxy WireGuard

on:
  pull_request:
  workflow_dispatch:

jobs:
  test-mitmproxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools dnsutils

      - name: Install Python dependencies
        run: |
          uv sync
          uv pip install mitmproxy

      - name: Setup network namespace for mitmproxy
        run: |
          # Create a network namespace for mitmproxy to avoid the host loop problem
          # See: https://docs.mitmproxy.org/stable/concepts/modes/#limitations

          # Create namespace
          sudo ip netns add mitmproxy-ns

          # Create veth pair to connect namespaces
          sudo ip link add veth-host type veth peer name veth-mitm

          # Move one end to the mitmproxy namespace
          sudo ip link set veth-mitm netns mitmproxy-ns

          # Configure the host side
          sudo ip addr add 192.168.100.1/24 dev veth-host
          sudo ip link set veth-host up

          # Configure the mitmproxy namespace side
          sudo ip netns exec mitmproxy-ns ip addr add 192.168.100.2/24 dev veth-mitm
          sudo ip netns exec mitmproxy-ns ip link set veth-mitm up
          sudo ip netns exec mitmproxy-ns ip link set lo up

          # Add default route in mitmproxy namespace to go through host
          sudo ip netns exec mitmproxy-ns ip route add default via 192.168.100.1

          # Enable IP forwarding and NAT on host
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE
          sudo iptables -A FORWARD -i veth-host -o eth0 -j ACCEPT
          sudo iptables -A FORWARD -i eth0 -o veth-host -m state --state RELATED,ESTABLISHED -j ACCEPT

          # Test connectivity from namespace
          echo "Testing namespace connectivity..."
          sudo ip netns exec mitmproxy-ns ping -c 1 8.8.8.8 || echo "Ping failed (might be blocked)"

      - name: Start mitmproxy in network namespace
        run: |
          VENV_BIN=$(dirname $(uv python find))

          # Start mitmproxy in the isolated namespace
          sudo ip netns exec mitmproxy-ns env \
            PATH="$VENV_BIN:$PATH" \
            PYTHONUNBUFFERED=1 \
            $VENV_BIN/mitmdump \
              --mode wireguard \
              --set block_global=false \
              -s mitmproxy_wg_logger.py \
              > /tmp/mitmproxy.log 2>&1 &

          echo "MITMPROXY_PID=$!" >> $GITHUB_ENV

          # Wait for mitmproxy to start
          echo "Waiting for mitmproxy to start..."
          for i in {1..30}; do
            if grep -q "WireGuard server listening" /tmp/mitmproxy.log 2>/dev/null; then
              echo "mitmproxy started"
              break
            fi
            sleep 1
          done

          cat /tmp/mitmproxy.log

      - name: Extract and setup WireGuard client
        run: |
          # Extract WireGuard config from mitmproxy output
          python3 << 'PYEOF'
          import re

          with open("/tmp/mitmproxy.log", "r") as f:
              content = f.read()

          config_lines = []
          in_config = False

          for line in content.split('\n'):
              if '[Interface]' in line:
                  in_config = True
                  config_lines.append('[Interface]')
                  continue

              if not in_config:
                  continue

              if '[Peer]' in line:
                  config_lines.append('')
                  config_lines.append('[Peer]')
                  continue

              if line.strip().startswith('---'):
                  break

              # Extract keys (skip DNS to use system resolver)
              for key in ['PrivateKey', 'Address', 'PublicKey', 'AllowedIPs', 'Endpoint']:
                  if key in line and '=' in line:
                      match = re.search(rf'{key}\s*=\s*(.+)', line)
                      if match:
                          value = match.group(1).strip()
                          # Replace endpoint IP with the namespace IP
                          if key == 'Endpoint':
                              # mitmproxy's endpoint needs to be the namespace IP
                              value = re.sub(r'^[\d.]+:', '192.168.100.2:', value)
                          config_lines.append(f'{key} = {value}')
                          break

          config = '\n'.join(config_lines)
          print("=== WireGuard client config ===")
          print(config)

          with open("/tmp/wg-client.conf", "w") as f:
              f.write(config)
          PYEOF

          # Setup WireGuard client on host
          sudo cp /tmp/wg-client.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          echo ""
          echo "=== WireGuard status ==="
          sudo wg show

      - name: Run connection tests
        run: |
          sleep 2
          python3 test_mitmproxy_connections.py
          sleep 3

      - name: Show mitmproxy logs
        if: always()
        run: |
          echo "=== mitmproxy logs ==="
          cat /tmp/mitmproxy.log || echo "No logs found"

      - name: Verify logged connections
        run: |
          echo "Checking for logged connections..."

          for pattern in "HTTP:" "DNS:" "TCP:" "UDP:"; do
            if grep -q "$pattern" /tmp/mitmproxy.log; then
              echo "PASS: $pattern found"
              grep "$pattern" /tmp/mitmproxy.log | head -3
            else
              echo "WARN: $pattern not found"
            fi
          done

          if grep -qE "(HTTP|DNS|TCP|UDP):" /tmp/mitmproxy.log; then
            echo "SUCCESS: Traffic was logged through mitmproxy"
          else
            echo "FAILED: No traffic was logged"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo wg-quick down wg0 || true
          sudo ip netns del mitmproxy-ns || true
          sudo pkill -f mitmdump || true
